DROP TABLE goods_orders IF EXISTS;
DROP TABLE goods_messages IF EXISTS;
DROP TABLE users_roles IF EXISTS;
DROP TABLE orders IF EXISTS;
DROP TABLE goods IF EXISTS;
DROP TABLE roles IF EXISTS;
DROP TABLE messages IF EXISTS;
DROP TABLE categories IF EXISTS;
DROP TABLE roles IF EXISTS;
DROP TABLE accounts IF EXISTS CASCADE;
DROP TABLE users IF EXISTS;

DROP SEQUENCE store_sequence IF EXISTS;

CREATE SEQUENCE store_sequence AS BIGINT START WITH 1;

CREATE TABLE categories (
  id BIGINT GENERATED BY DEFAULT AS SEQUENCE store_sequence PRIMARY KEY,
  name CHARACTER VARYING (255) NOT NULL,
  parent_id BIGINT,
  FOREIGN KEY ( parent_id ) REFERENCES categories ( id ) ON DELETE CASCADE,
  characteristics_template  VARCHAR(255)
);

CREATE TABLE accounts (
  id BIGINT GENERATED BY DEFAULT AS SEQUENCE store_sequence PRIMARY KEY,
  name CHARACTER VARYING (255),
  amount DOUBLE PRECISION,
  user_id BIGINT,
  UNIQUE (user_id, name)
);

CREATE TABLE users (
  id BIGINT GENERATED BY DEFAULT AS SEQUENCE store_sequence PRIMARY KEY,
  username CHARACTER VARYING (255) NOT NULL,
  password CHARACTER VARYING (255) NOT NULL,
  first_name CHARACTER VARYING (255),
  last_name CHARACTER VARYING (255),
  address CHARACTER VARYING (255),
  registration_date TIMESTAMP DEFAULT now(),
  email CHARACTER VARYING (255) NOT NULL,
  avatar BLOB,
  account_id BIGINT,
  activity_status CHARACTER VARYING (255) NOT NULL,
  UNIQUE (username, email),
  FOREIGN KEY (account_id) REFERENCES ACCOUNTS (id) ON DELETE CASCADE
);

ALTER TABLE accounts
ADD FOREIGN KEY (user_id) REFERENCES USERS (id);




CREATE TABLE orders (
  id BIGINT GENERATED BY DEFAULT AS SEQUENCE store_sequence PRIMARY KEY,
  start_date TIMESTAMP NOT NULL,
  delivery_type CHARACTER VARYING (255) NOT NULL,
  address CHARACTER VARYING (255),
  order_status CHARACTER VARYING (255) NOT NULL,
  user_id BIGINT NOT NULL,
  FOREIGN KEY (user_id) REFERENCES USERS (id) ON DELETE CASCADE
);

CREATE TABLE goods (
  id BIGINT GENERATED BY DEFAULT AS SEQUENCE store_sequence PRIMARY KEY,
  name CHARACTER VARYING (255) NOT NULL,
  article CHARACTER VARYING(255) NOT NULL,
  counts BIGINT NOT NULL,
  category_id BIGINT NOT NULL,
  price double precision NOT NULL,
  producer CHARACTER VARYING (255) NOT NULL,
  image BLOB,
  FOREIGN KEY (category_id) REFERENCES CATEGORIES (id) ON DELETE CASCADE
);

CREATE TABLE roles (
  name CHARACTER VARYING (255) NOT NULL PRIMARY KEY
);

CREATE TABLE messages (
  id BIGINT GENERATED BY DEFAULT AS SEQUENCE store_sequence PRIMARY KEY,
  message CHARACTER VARYING (255) NOT NULL,
  message_type CHARACTER VARYING (255) NOT NULL,
  user_id BIGINT NOT NULL,
  FOREIGN KEY (user_id) REFERENCES USERS (id) ON DELETE CASCADE
);

CREATE TABLE goods_messages (
  goods_id BIGINT NOT NULL,
  messages_id BIGINT NOT NULL,
  FOREIGN KEY (goods_id) REFERENCES GOODS (id) ON DELETE CASCADE,
  FOREIGN KEY (messages_id) REFERENCES GOODS (id) ON DELETE CASCADE,
  UNIQUE (messages_id)

);

CREATE TABLE goods_orders (
  goods_id BIGINT NOT NULL,
  orders_id BIGINT NOT NULL,
  FOREIGN KEY (goods_id) REFERENCES GOODS (id) ON DELETE CASCADE,
  FOREIGN KEY (orders_id) REFERENCES GOODS (id) ON DELETE CASCADE
);

CREATE TABLE users_roles (
  user_id BIGINT NOT NULL ,
  role VARCHAR(255) NOT NULL,
  FOREIGN KEY (user_id) REFERENCES USERS (id) ON DELETE CASCADE,
  FOREIGN KEY (role) REFERENCES ROLES (name) ON DELETE CASCADE
);

INSERT INTO roles (name) VALUES ('ADMIN'), ('USER'), ('CONTENT_MANAGER'), ('SUPPORT');